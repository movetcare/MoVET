
  <!DOCTYPE html>
  <html>
    <head>
      <title>updateBookingCancellation.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts</td><td class="">80.93%</td><td class="">75%</td><td class="">194</td><td class="">157</td><td class="">37</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import { DEBUG } from &quot;../../config/config&quot;;
import { createProVetNote } from &quot;../../integrations/provet/entities/note/createProVetNote&quot;;
import { sendNotification } from &quot;../../notifications/sendNotification&quot;;
import type { Booking } from &quot;../../types/booking&quot;;
import { formatPhoneNumber } from &quot;../../utils/formatPhoneNumber&quot;;
import { getYYMMDDFromString } from &quot;../../utils/getYYMMDDFromString&quot;;

export const updateBookingCancellation = async (
  id: string,
  {
    client,
    patients,
    reason,
    requestedDateTime,
    location,
    address,
    selectedStaff,
    cancelReason,
    cancelDetails,
    selectedPatients,
  }: Booking
) =&gt; {
  if (cancelReason) {
    let message = `&lt;p&gt;CANCELLATION REASON: ${cancelReason}&lt;/p&gt;&lt;p&gt;CANCELLATION DETAILS: ${
      cancelDetails ? cancelDetails : &quot;None Provided (Yet)&quot;
    }&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Session ID:&lt;/b&gt; ${id}&lt;/p&gt;`;
    let allPatients = &quot;&quot;;
    if (Array.isArray(selectedPatients) &amp;&amp; Array.isArray(patients))
      selectedPatients.forEach((selectedPatient: any) =&gt; {
        patients.map((patient: any) =&gt; {
          if (selectedPatient === patient?.id)
            allPatients += `&lt;p&gt;&lt;b&gt;------------- PATIENT -------------&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Name:&lt;/b&gt; ${
              patient?.name
            }&lt;/p&gt;&lt;p&gt;&lt;b&gt;Species:&lt;/b&gt; ${patient?.species}&lt;/p&gt;&lt;p&gt;&lt;b&gt;Gender:&lt;/b&gt; ${
              patient?.gender
            }&lt;/p&gt;${
              patient?.illnessDetails
                ? `&lt;p&gt;&lt;b&gt;Minor Illness:&lt;/b&gt; ${
                    patient?.illnessDetails
                      ? `${JSON.stringify(
                          patient?.illnessDetails?.symptoms
                        )} - ${patient?.illnessDetails?.notes}`
                      : &quot; None&quot;
                  }&lt;/p&gt;`
                : &quot;&quot;
            }&lt;p&gt;&lt;b&gt;-----------------------------------&lt;/b&gt;&lt;/p&gt;`;
        });
      });
    if (client)
      message += `${
        client?.firstName &amp;&amp; client?.lastName
          ? `&lt;p&gt;&lt;b&gt;Name:&lt;/b&gt; ${client?.firstName} ${client?.lastName}&lt;/p&gt;`
          : &quot;&quot;
      }&lt;p&gt;&lt;b&gt;Email:&lt;/b&gt; ${client.email}&lt;/p&gt;${
        client.phone
          ? `&lt;p&gt;&lt;b&gt;Phone:&lt;/b&gt; &lt;a href=&quot;tel://${
              client.phone
            }&quot;&gt;${formatPhoneNumber(client.phone?.replaceAll(&quot;+1&quot;, &quot;&quot;))}&lt;/a&gt;&lt;/p&gt;`
          : &quot;&quot;
      }${allPatients}
    ${
      reason
        ? `&lt;p&gt;&lt;b&gt;Reason:&lt;/b&gt; ${reason.label}&lt;/p&gt;`
        : &quot;&lt;p&gt;&lt;b&gt;Reason:&lt;/b&gt; Establish Care Exam&lt;/p&gt;&quot;
    }
    ${
      requestedDateTime?.date
        ? `&lt;p&gt;&lt;b&gt;Requested Date:&lt;/b&gt; ${getYYMMDDFromString(
            requestedDateTime.date
          )}&lt;/p&gt;`
        : &quot;&quot;
    }${
        requestedDateTime?.time
          ? `&lt;p&gt;&lt;b&gt;Requested Time:&lt;/b&gt; ${requestedDateTime.time}&lt;/p&gt;`
          : &quot;&quot;
      }${
        location
          ? `&lt;p&gt;&lt;b&gt;Requested Location:&lt;/b&gt; ${location} ${
              address ? `- ${address?.full} (${address?.info})` : &quot;&quot;
            }&lt;/p&gt;`
          : &quot;&quot;
      }${
        selectedStaff
          ? `&lt;p&gt;&lt;b&gt;Requested Expert:&lt;/b&gt; ${selectedStaff?.title} ${selectedStaff?.firstName} ${selectedStaff?.lastName}&lt;/p&gt;`
          : &quot;&quot;
      }&lt;p&gt;&lt;/p&gt;&lt;p&gt;We look forward to seeing you soon!&lt;/p&gt;&lt;p&gt;- The MoVET Team&lt;/p&gt;`;

    const subject = `Appointment Booking Request Cancellation Reason Provided: &quot;${cancelReason?.toUpperCase()}&quot;`;
    sendNotification({
      type: &quot;email&quot;,
      payload: {
        to: &quot;info@movetcare.com&quot;,
        replyTo: client?.email,
        subject,
        message,
      },
    });

    const allPatientIds: any = [];
    if (Array.isArray(selectedPatients) &amp;&amp; Array.isArray(patients))
      selectedPatients.forEach((selectedPatient: any) =&gt; {
        patients.map((patient: any) =&gt; {
          if (selectedPatient === patient?.id)
            allPatientIds.push(patient?.id || patient?.value);
        });
      });

    if (DEBUG)
      console.log(&quot;createProVetNote() =&gt;&quot;, {
        type: 1,
        subject,
        message,
        client: `${client?.uid}`,
        patients: Array.isArray(selectedPatients) ? allPatientIds : [],
      });

    createProVetNote({
      type: 4,
      subject,
      message,
      client: `${client?.uid}`,
      patients: Array.isArray(selectedPatients) ? allPatientIds : [],
    });
  }
  sendNotification({
    type: &quot;slack&quot;,
    payload: {
      channel: &quot;appointment-request&quot;,
      message: [
        {
          type: &quot;section&quot;,
          text: {
            text: &quot;:book: _Appointment Booking_ *CANCELLED*&quot;,
            type: &quot;mrkdwn&quot;,
          },
          fields: [
            {
              type: &quot;mrkdwn&quot;,
              text: &quot;*Session ID*&quot;,
            },
            {
              type: &quot;plain_text&quot;,
              text: id,
            },
            {
              type: &quot;mrkdwn&quot;,
              text: &quot;*Step*&quot;,
            },
            {
              type: &quot;plain_text&quot;,
              text: &quot;CANCELLED BY CLIENT&quot;,
            },
            {
              type: &quot;mrkdwn&quot;,
              text: &quot;*Reason*&quot;,
            },
            {
              type: &quot;plain_text&quot;,
              text: `${
                cancelDetails
                  ? `${cancelReason} - ${cancelDetails}`
                  : cancelReason
              }`,
            },
          ],
        },
      ],
    },
  });
};
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:28,&quot;character&quot;:32,&quot;text&quot;:&quot;selectedPatient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:29,&quot;character&quot;:22,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:30,&quot;character&quot;:14,&quot;text&quot;:&quot;selectedPatient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:30,&quot;character&quot;:34,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:30,&quot;character&quot;:43,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:32,&quot;character&quot;:14,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:32,&quot;character&quot;:23,&quot;text&quot;:&quot;name&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:33,&quot;character&quot;:38,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:33,&quot;character&quot;:47,&quot;text&quot;:&quot;species&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:34,&quot;character&quot;:14,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:34,&quot;character&quot;:23,&quot;text&quot;:&quot;gender&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:36,&quot;character&quot;:14,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:36,&quot;character&quot;:23,&quot;text&quot;:&quot;illnessDetails&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:38,&quot;character&quot;:20,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:38,&quot;character&quot;:29,&quot;text&quot;:&quot;illnessDetails&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:40,&quot;character&quot;:26,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:40,&quot;character&quot;:35,&quot;text&quot;:&quot;illnessDetails&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:40,&quot;character&quot;:51,&quot;text&quot;:&quot;symptoms&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:41,&quot;character&quot;:31,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:41,&quot;character&quot;:40,&quot;text&quot;:&quot;illnessDetails&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:41,&quot;character&quot;:56,&quot;text&quot;:&quot;notes&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:66,&quot;character&quot;:25,&quot;text&quot;:&quot;date&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:68,&quot;character&quot;:30,&quot;text&quot;:&quot;date&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:98,&quot;character&quot;:10,&quot;text&quot;:&quot;allPatientIds&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:100,&quot;character&quot;:32,&quot;text&quot;:&quot;selectedPatient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:101,&quot;character&quot;:22,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:102,&quot;character&quot;:14,&quot;text&quot;:&quot;selectedPatient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:102,&quot;character&quot;:34,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:102,&quot;character&quot;:43,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:103,&quot;character&quot;:12,&quot;text&quot;:&quot;allPatientIds&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:103,&quot;character&quot;:26,&quot;text&quot;:&quot;push&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:103,&quot;character&quot;:31,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:103,&quot;character&quot;:40,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:103,&quot;character&quot;:46,&quot;text&quot;:&quot;patient&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:103,&quot;character&quot;:55,&quot;text&quot;:&quot;value&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:113,&quot;character&quot;:8,&quot;text&quot;:&quot;patients&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/booking/abandonment/updateBookingCancellation.ts&quot;,&quot;line&quot;:113,&quot;character&quot;:52,&quot;text&quot;:&quot;allPatientIds&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 02 Mar 2023 15:37:59 GMT</p>
    </body>
  </html>
  