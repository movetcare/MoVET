
  <!DOCTYPE html>
  <html>
    <head>
      <title>handleK9SmilesRequest.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts</td><td class="">73.01%</td><td class="">75%</td><td class="">163</td><td class="">119</td><td class="">44</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import { sendNotification } from &quot;../notifications/sendNotification&quot;;
import { environment, functions } from &quot;../config/config&quot;;
import { UserRecord } from &quot;firebase-admin/lib/auth/user-record&quot;;
import { getAuthUserByEmail } from &quot;../utils/auth/getAuthUserByEmail&quot;;
import { createProVetNote } from &quot;../integrations/provet/entities/note/createProVetNote&quot;;
import { formatPhoneNumber } from &quot;../utils/formatPhoneNumber&quot;;
import { createProVetClient } from &quot;../integrations/provet/entities/client/createProVetClient&quot;;
import { updateProVetClient } from &quot;../integrations/provet/entities/client/updateProVetClient&quot;;
const DEBUG = environment?.type === &quot;production&quot;;
export const handleK9SmilesRequest = functions.firestore
  .document(&quot;k9_smiles/{id}&quot;)
  .onWrite(async (change: any, context: any) =&gt; {
    const { id } = context.params || {};
    const data = change.after.data();
    if (DEBUG)
      console.log(&quot;handleK9SmilesRequest =&gt; DATA&quot;, {
        id,
        data,
      });
    const { email, firstName, lastName, phone, source, status } = data as {
      email: string;
      firstName: string;
      lastName: string;
      phone: string;
      source: string;
      status: string;
    };
    if (status === &quot;started&quot;) {
      const authUser: UserRecord | any = await getAuthUserByEmail(email);
      let didUpdateClientInfo = false;
      if (DEBUG) console.log(&quot;authUser&quot;, authUser);
      if (authUser === null) {
        const proVetClientData: any = await createProVetClient({
          email,
          firstname: firstName,
          lastname: lastName,
          zip_code: null,
        });
        if (DEBUG) console.log(&quot;proVetClientData?.id&quot;, proVetClientData?.id);
        didUpdateClientInfo = await updateProVetClient({
          phone,
          id: proVetClientData?.id,
        });
        authUser.uid = proVetClientData?.id;
      } else {
        didUpdateClientInfo = await updateProVetClient({
          firstname: firstName,
          lastname: lastName,
          phone,
          id: authUser?.uid,
        });
      }
      if (DEBUG) console.log(&quot;didUpdateClientInfo&quot;, didUpdateClientInfo);
      if (
        !email?.toLowerCase()?.includes(&quot;+test&quot;) &amp;&amp;
        didUpdateClientInfo &amp;&amp;
        authUser?.uid !== null
      ) {
        sendNotification({
          type: &quot;slack&quot;,
          payload: {
            channel: &quot;appointment-request&quot;,
            message: [
              {
                type: &quot;section&quot;,
                text: {
                  text: `:toothbrush: _New K-9 Smiles Appointment Request!_ - ${id} :toothbrush:`,
                  type: &quot;mrkdwn&quot;,
                },
                fields: [
                  {
                    type: &quot;mrkdwn&quot;,
                    text: &quot;*FIRST NAME:*&quot;,
                  },
                  {
                    type: &quot;plain_text&quot;,
                    text: firstName,
                  },
                  {
                    type: &quot;mrkdwn&quot;,
                    text: &quot;*LAST NAME:*&quot;,
                  },
                  {
                    type: &quot;plain_text&quot;,
                    text: lastName,
                  },
                  {
                    type: &quot;mrkdwn&quot;,
                    text: &quot;*EMAIL:*&quot;,
                  },
                  {
                    type: &quot;plain_text&quot;,
                    text: email,
                  },
                  {
                    type: &quot;mrkdwn&quot;,
                    text: &quot;*PHONE:*&quot;,
                  },
                  {
                    type: &quot;plain_text&quot;,
                    text: phone,
                  },
                  {
                    type: &quot;mrkdwn&quot;,
                    text: &quot;*SOURCE:*&quot;,
                  },
                  {
                    type: &quot;plain_text&quot;,
                    text: source,
                  },
                ],
              },
            ],
          },
        });
        createProVetNote({
          type: 1,
          subject: `New K-9 Smiles Appointment Request from ${firstName} ${lastName} @ ${source}`,
          message: `&lt;p&gt;&lt;b&gt;Name:&lt;/b&gt; ${firstName} ${lastName}&lt;/p&gt;&lt;p&gt;&lt;b&gt;Email:&lt;/b&gt; ${email}&lt;/p&gt;&lt;p&gt;&lt;b&gt;Phone:&lt;/b&gt; &lt;a href=&quot;tel://+1${phone}&quot;&gt;${formatPhoneNumber(
            phone
          )}&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Source:&lt;/b&gt; ${source}&lt;/p&gt;`,
          client: authUser?.uid as string,
          patients: [],
        });
        return true;
      } else {
        if (DEBUG)
          console.log(&quot;SKIPPED NOTIFICATION&quot;, {
            email: !email?.toLowerCase()?.includes(&quot;+test&quot;),
            didUpdateClientInfo,
            authUserUid: authUser?.uid,
          });
        return false;
      }
    } else return false;
  });
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:1,&quot;character&quot;:9,&quot;text&quot;:&quot;environment&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:1,&quot;character&quot;:22,&quot;text&quot;:&quot;functions&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:8,&quot;character&quot;:14,&quot;text&quot;:&quot;environment&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:8,&quot;character&quot;:27,&quot;text&quot;:&quot;type&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:9,&quot;character&quot;:13,&quot;text&quot;:&quot;handleK9SmilesRequest&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:9,&quot;character&quot;:37,&quot;text&quot;:&quot;functions&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:9,&quot;character&quot;:47,&quot;text&quot;:&quot;firestore&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:10,&quot;character&quot;:3,&quot;text&quot;:&quot;document&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:11,&quot;character&quot;:3,&quot;text&quot;:&quot;onWrite&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:11,&quot;character&quot;:18,&quot;text&quot;:&quot;change&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:11,&quot;character&quot;:31,&quot;text&quot;:&quot;context&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:12,&quot;character&quot;:12,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:12,&quot;character&quot;:19,&quot;text&quot;:&quot;context&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:12,&quot;character&quot;:27,&quot;text&quot;:&quot;params&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:13,&quot;character&quot;:10,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:13,&quot;character&quot;:17,&quot;text&quot;:&quot;change&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:13,&quot;character&quot;:24,&quot;text&quot;:&quot;after&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:13,&quot;character&quot;:30,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:16,&quot;character&quot;:8,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:17,&quot;character&quot;:8,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:28,&quot;character&quot;:12,&quot;text&quot;:&quot;authUser&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:30,&quot;character&quot;:41,&quot;text&quot;:&quot;authUser&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:31,&quot;character&quot;:10,&quot;text&quot;:&quot;authUser&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:32,&quot;character&quot;:14,&quot;text&quot;:&quot;proVetClientData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:38,&quot;character&quot;:55,&quot;text&quot;:&quot;proVetClientData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:38,&quot;character&quot;:73,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:41,&quot;character&quot;:10,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:41,&quot;character&quot;:14,&quot;text&quot;:&quot;proVetClientData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:41,&quot;character&quot;:32,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:43,&quot;character&quot;:8,&quot;text&quot;:&quot;authUser&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:43,&quot;character&quot;:17,&quot;text&quot;:&quot;uid&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:43,&quot;character&quot;:23,&quot;text&quot;:&quot;proVetClientData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:43,&quot;character&quot;:41,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:49,&quot;character&quot;:10,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:49,&quot;character&quot;:14,&quot;text&quot;:&quot;authUser&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:49,&quot;character&quot;:24,&quot;text&quot;:&quot;uid&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:56,&quot;character&quot;:8,&quot;text&quot;:&quot;authUser&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:56,&quot;character&quot;:18,&quot;text&quot;:&quot;uid&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:66,&quot;character&quot;:80,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:121,&quot;character&quot;:18,&quot;text&quot;:&quot;authUser&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:121,&quot;character&quot;:28,&quot;text&quot;:&quot;uid&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:130,&quot;character&quot;:12,&quot;text&quot;:&quot;authUserUid&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:130,&quot;character&quot;:25,&quot;text&quot;:&quot;authUser&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;apps/api.movetcare.com/src/triggers/handleK9SmilesRequest.ts&quot;,&quot;line&quot;:130,&quot;character&quot;:35,&quot;text&quot;:&quot;uid&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 02 Mar 2023 15:37:59 GMT</p>
    </body>
  </html>
  